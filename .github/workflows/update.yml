name: Update addons data
on:
    workflow_dispatch:
        inputs:
            Version:
                required: false
                type: string
    schedule:
        - cron: 30 11/12 * * *

permissions: write-all

jobs:
    update:
        name: Update
        runs-on: ubuntu-20.04

        steps:
            # Clone
            - uses: actions/checkout@v4.1.0
              with:
                  repository: ScratchAddons/ScratchAddons
                  sparse-checkout: |
                      addons/*/addon.json
                      addons/addons.json
                  sparse-checkout-cone-mode: false
                  fetch-tags: true
            - run: cd ScratchAddons
            - run: ls -a
            # Checkout
            - run: VERSION="${{ inputs.Version || env.LATEST }}"
              env:
                  LATEST: $(git rev-list --tags --timestamp --no-walk | sort -nr | head -n1 | cut -f 2 -d ' ')
            - run: git checkout $VERSION
            # Get package
            - run: cd ../dist
            - run: cat ../package.json | sed "s/__MSG_VERSION__/$VERSION/g" > package.json
            # Get addons
            - run: echo [ > addons.json
            - run: addons = `jq -r '.[]' ../ScratchAddons/addons/addons.json`
            - run: |
                  for addon in "${addons[@]}"; do
                    cat "../ScratchAddons/addons/$addon/addon.json" >> addons.json
                    echo , >> addons.json
                  done
            - run: echo ] >> addons.json
            # Publish
            - uses: actions/setup-node@v3
              with:
                  registry-url: "https://registry.npmjs.org"
            # - run: npm publish
            #   env:
            #       NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
