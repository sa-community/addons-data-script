name: Update addons data
on:
    workflow_dispatch:
        inputs:
            Version:
                required: false
                type: string
    schedule:
        - cron: 30 11/12 * * *

permissions: write-all

jobs:
    update:
        name: Update
        runs-on: ubuntu-20.04

        steps:
            # Clone
            - run: git clone https://github.com/ScratchAddons/ScratchAddons.git --depth=1 --sparse
            - run: cd ScratchAddons
            - run: git config --global --add safe.directory $(realpath .)
            # Checkout
            - run: git fetch --tags
            - run: VERSION = `git rev-list --tags --timestamp --no-walk | sort -nr | head -n1 | cut -f 2 -d ' '`
            - run: git checkout $VERSION
            - run: git sparse-checkout add "addons/*/addon.json" addons/addons.json
            # Get package
            - run: cd ../dist
            - run: cat ../package.json | sed "s/__MSG_VERSION__/$VERSION/g" > package.json
            # Get addons
            - run: echo [ > addons.json
            - run: addons = `jq -r '.[]' ../ScratchAddons/addons/addons.json`
            - run: |
                  for addon in "${addons[@]}"; do
                    cat "../ScratchAddons/addons/$addon/addon.json" >> addons.json
                    echo , >> addons.json
                  done
            - run: echo ] >> addons.json
            # Publish
            - uses: actions/setup-node@v3
              with:
                  registry-url: "https://registry.npmjs.org"
            # - run: npm publish
            #   env:
            #       NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
